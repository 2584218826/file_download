<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>文件下载器</title>
    <link rel="stylesheet" th:href="@{/index.css}" />
    <link rel="stylesheet" th:href="@{/diy.css}" />
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- 引入组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
</head>

<body>
      <div id="app" class="content">
          <h1 class="head">小云下载器</h1>
          <h1 id="msg"></h1>
          <input type="text" id="downUrl" class="input" name="downUrl" placeholder="请输入文件下载地址"/>
          <button ref="btn" v-bind:class="{'disable-button':downloadFlag}" class="button" style="vertical-align:middle" @click="download()"><span>下载文件</span></button>
          <div class="loader"  style="display: none">
              <div class="downClass">
                  <span v-if="this.downFile.fileSize">{{this.downFile.downloaded}}/{{this.downFile.fileSize}}</span>
              </div>
              <el-progress :show-text="true" :percentage="schedule" :color="customColorMethod"></el-progress>

          </div>
          <el-card v-if="visible" style="width: 600px;margin: 40px auto">
              <el-descriptions title="文件信息" :column="1">
                  <el-descriptions-item label="文件名">{{this.fileInfo.fileName}}</el-descriptions-item>
                  <el-descriptions-item label="下载地址">
                      <div class="url">
                          <span>{{this.fileInfo.fileUrl}} &nbsp;</span>
                          <i class="el-icon-copy-document icon" @click="copyToClickBoard"></i>
                      </div>
                  </el-descriptions-item>
                  <el-descriptions-item label="下载用时">{{this.fileInfo.downTime}}</el-descriptions-item>
                  <el-descriptions-item label="文件大小">{{this.fileInfo.fileSize}}</el-descriptions-item>
              </el-descriptions>
              <el-button v-if="fileInfo" type="success" @click="downloadEvt">下载至本地</el-button>
          </el-card>
      </div>
</body>

<script>
    let task;
    new Vue({
        el: '#app',
        data() {
            return {
                msg:null,
                downloadFlag:false,
                schedule:0,
                visible: false,
                task:null,
                fileInfo:{

                },
                downFile:{}
            }
        },
        methods:{
            download(){
                if (this.downloadFlag){
                    return;
                }
                this.schedule = 0;
                this.visible = false
                this.downloadFlag = true
                let downUrl = document.getElementById('downUrl').value;
                let flag = this.verify(downUrl);
                let msg = document.getElementById('msg');
                if (!flag){
                    msg.innerHTML = '下载地址不合法';
                    setTimeout(()=>{
                        msg.innerHTML = '';
                    },3000)
                    return;
                }
                let fileName = this.getFileName(downUrl);
                let self = this;
                this.loadCloseOrOpen();
                axios.post('/download', {
                    downUrl: downUrl,
                }).then(function (response) {
                    msg.innerHTML = response.data;
                    this.msg = msg.innerHTML
                    setTimeout(()=>{
                        msg.innerHTML = '';
                    },3000)
                    self.loadCloseOrOpen()
                    self.downloadFlag = false
                    console.log(this.msg)
                    if (this.msg==='下载成功'){
                        self.getFileInfo(fileName)
                        self.visible = true

                    }
                    console.log('msg.innerHTML',msg.innerHTML)
                })
                task = setInterval(()=>{
                    this.refreshProgress(fileName)
                },1000);
            },
            verify(downUrl){
                if (downUrl.indexOf('http')<0 && downUrl.indexOf('https')<0){
                    return false;
                }else {
                    return true;
                }
            },
            downloadEvt(url) {
                url = this.fileInfo.fileUrl
                const el = document.createElement('a');
                el.style.display = 'none';
                el.setAttribute('target', '_blank');
                /**
                 * download的属性是HTML5新增的属性
                 * href属性的地址必须是非跨域的地址，如果引用的是第三方的网站或者说是前后端分离的项目(调用后台的接口)，这时download就会不起作用。
                 * 此时，如果是下载浏览器无法解析的文件，例如.exe,.xlsx..那么浏览器会自动下载，但是如果使用浏览器可以解析的文件，比如.txt,.png,.pdf....浏览器就会采取预览模式
                 * 所以，对于.txt,.png,.pdf等的预览功能我们就可以直接不设置download属性(前提是后端响应头的Content-Type: application/octet-stream，如果为application/pdf浏览器则会判断文件为 pdf ，自动执行预览的策略)
                 */
                el.setAttribute('download', this.getFileName(url));
                el.href = url;
                document.body.appendChild(el);
                el.click();
                document.body.removeChild(el);
            },
            loadCloseOrOpen(){
                let load = document.getElementsByClassName('loader')[0];
                if (load.style.display==='none'){
                    load.style.display = ''
                }else {
                    load.style.display='none'
                }
            },
            refreshProgress(fileName){
                if (!fileName){
                    return
                }
                let self = this
                axios.get('/getDownResult/'+fileName)
                    .then(function (res){
                        if (res.data){
                            self.schedule = parseInt(res.data.downRate.substr(0,res.data.downRate.length-1))
                            self.downFile = res.data
                            console.log('正在下载')
                            console.log(res.data)
                        }else {
                            console.log('下载完成')

                            clearInterval(task)
                        }
                    })
            },
            getFileName(url){
                let fileName = url.split('/')[url.split('/').length - 1]
                if (fileName.indexOf('?')){
                    fileName = fileName.split('?')[0]
                }
                return fileName
            },
            // 获取文件信息
            getFileInfo(fileName){
                if (fileName){
                    axios.get('/getFileInfo/'+fileName).then((res)=>{
                        this.fileInfo = res.data;
                        console.log(this.fileInfo)
                    })
                }else {
                    console.log('文件名为空')
                }

            },
            customColorMethod(percentage) {
                if (percentage < 30) {
                    return '#909399';
                } else if (percentage < 70) {
                    return '#e6a23c';
                } else {
                    return '#67c23a';
                }
            },
            //  拷贝内容到剪切板
            copyToClickBoard(){
                navigator.clipboard.writeText(this.fileInfo.fileUrl)
                    .then(() => {
                        this.$message({
                            message: '文件地址拷贝成功',
                            type: 'success'
                        });
                    })
                    .catch(err => {
                        this.$message({
                            message: '拷贝失败',
                            type: 'error'
                        });
                    })

            }
        }
    })
</script>
</html>
